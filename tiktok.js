const translations = {
  en: {
    'lang.option.en': 'English',
    'lang.option.ja': '日本語',
    'lang.option.zh': '中文',
    'nav.projects': 'Projects',
    'nav.journey': 'Journey',
    'nav.contact': 'Contact',
    'hero.greeting': 'Hi,',
    'hero.name': "I'm Xinrou",
    'hero.lead': 'Embracing the world and its endless possibilities, I long to spread happiness to those who walk with me.',
    'hero.contact': 'Contact Me',
    'labs.title': 'Project Highlights',
    'labs.card1.tag': 'LIVE-AI',
    'labs.card1.title': 'Neon Pulse Studio',
    'labs.card1.desc': 'An interactive live room where GPT agents remix prompts, beats, and lights in real time.',
    'labs.card1.meta': '2024 · Beta',
    'labs.card2.tag': 'AR',
    'labs.card2.title': 'Holo Loop',
    'labs.card2.desc': 'A wearable particle loop crafted with WebAR and Effect House that shifts colors with every beat.',
    'labs.card2.meta': '2023 · Launch',
    'labs.card3.tag': 'DATA',
    'labs.card3.title': 'Creator Radar',
    'labs.card3.desc': 'A signal board combining TikTok API stats, commerce conversion, and content insights for brands.',
    'labs.card3.meta': '2022 · SaaS',
    'timeline.title': 'Life is an adventure, and this is my journey',
    'timeline.item1.title': '2023 - Now · Creative Tech Lead',
    'timeline.item1.desc': 'Designing commerce-ready livestream systems with AI scene direction and automated overlays.',
    'timeline.item2.title': '2021 - 2023 · Product Storyteller',
    'timeline.item2.desc': 'Directed TikTok-first campaign narratives for lifestyle brands entering short-video ecosystems.',
    'timeline.item3.title': '2019 - 2021 · Immersive Developer',
    'timeline.item3.desc': 'Built AR filters, motion capture puppets, and interactive microsites with cross-device syncing.',
    'timeline.item4.title': '2017 - 2019 · Visual Designer',
    'timeline.item4.desc': 'Crafted kinetic typography packages and festival visuals for entertainment & tech partners.',
    'skills.title': 'Languages & Capabilities',
    'skills.language.title': 'Language Skill',
    'skills.language.english': 'English: full professional proficiency',
    'skills.language.mandarin': 'Mandarin: Native',
    'skills.language.japanese': 'Japanese: full professional proficiency',
    'skills.programming.title': 'Programming Skill',
    'skills.programming.item1': 'TypeScript / React / Next.js frontends',
    'skills.programming.item2': 'Three.js, WebGL, and shader animation',
    'skills.programming.item3': 'Node.js automation & AI toolchains',
    'skills.professional.title': 'Professional Skill',
    'skills.professional.item1': 'Creative direction & interactive storytelling',
    'skills.professional.item2': 'Campaign measurement & content ops',
    'skills.professional.item3': 'Client workshop facilitation',
    'split.offer.title': 'This is me',
    'split.offer.item1': 'A passionate partner',
    'split.offer.item2': "A friend who's endlessly curious about the world",
    'split.offer.item3': 'A globally minded multilingual communicator',
    'split.offer.item4': 'A partner committed to lifelong learning',
    'split.contact.title': 'Contact Me',
    'split.contact.body': "Please feel free to contact me anytime—I'm very happy to meet and chat with you.",
    'split.contact.mail': 'Mail',
    'footer.copy': '© 2025 Xinrou · My Page',
    'chatbot.title': 'Chat with me',
    'chatbot.lead': 'Ask anything about my work, interests, or ideas. Pre-filled cards help you start quickly.',
    'chatbot.input.placeholder': 'Type your question...',
    'chatbot.noKey': 'Just start chatting—no setup required.',
    'chatbot.send': 'Send',
    'chatbot.quick.q1': 'What is your future career aspiration?',
    'chatbot.quick.q2': 'What steps have you taken toward it?',
    'chatbot.quick.q3': "Want to grab a coffee chat?",
    'chatbot.welcome': "Nice to chat with you! I'm Xinrou—what would you like to ask me?",
    'chatbot.error': 'Oops, I could not reach the model. Please try again.',
    'chatbot.empty': 'I did not get a response. Could you retry?',
    'chatbot.systemPrompt': "You are Xinrou's friendly assistant. Answer concisely, warmly, and invite collaboration.",
    'chatbot.note': 'Answers come from my personal assistant to help you get to know me.',
    'contact.table.title': 'Leave your info for a quick follow-up',
    'contact.table.name': 'Name',
    'contact.table.firstName': 'First name',
    'contact.table.lastName': 'Last name',
    'contact.table.org': 'Organization name',
    'contact.table.email': 'Email',
    'contact.table.message': 'Inquiry',
    'contact.table.submit': 'Draft email',
    'contact.table.helper': 'A mail draft will open with your details. Feel free to edit before sending.',
  },
  zh: {
    'lang.option.en': '英文',
    'lang.option.ja': '日文',
    'lang.option.zh': '中文',
    'nav.projects': '项目',
    'nav.journey': '经历',
    'nav.contact': '联系',
    'hero.greeting': '你好，',
    'hero.name': '我是Xinrou',
    'hero.lead': '拥抱世界，探索生活的每一种可能，我想把快乐带给身边的人。',
    'hero.contact': '联系我',
    'labs.title': '项目亮点',
    'labs.card1.tag': 'LIVE-AI',
    'labs.card1.title': '霓虹脉冲工作室',
    'labs.card1.desc': '一个互动直播间，GPT代理会实时混合提示词、节奏和灯光。',
    'labs.card1.meta': '2024 · 测试版',
    'labs.card2.tag': 'AR',
    'labs.card2.title': '全息回环',
    'labs.card2.desc': '一款使用 WebAR 和 Effect House 打造的可穿戴粒子回环，会随着每一次节奏变化变色。',
    'labs.card2.meta': '2023 · 上线',
    'labs.card3.tag': 'DATA',
    'labs.card3.title': '创作者雷达',
    'labs.card3.desc': '一个结合 TikTok API 数据、商业转化与内容洞察的信号面板，服务品牌决策。',
    'labs.card3.meta': '2022 · SaaS',
    'timeline.title': '人生如旷野，这是我的旅程',
    'timeline.item1.title': '2023 至今 · 创意科技负责人',
    'timeline.item1.desc': '设计具备 AI 场景导演与自动叠加的商业直播系统。',
    'timeline.item2.title': '2021 - 2023 · 产品叙事者',
    'timeline.item2.desc': '为生活方式品牌打造面向 TikTok 的首发活动故事。',
    'timeline.item3.title': '2019 - 2021 · 沉浸式开发者',
    'timeline.item3.desc': '构建 AR 滤镜、动作捕捉木偶以及多设备同步的互动站点。',
    'timeline.item4.title': '2017 - 2019 · 视觉设计师',
    'timeline.item4.desc': '为娱乐与科技伙伴创作动感字体包装与节日视觉。',
    'skills.title': '语言与能力',
    'skills.language.title': '语言技能',
    'skills.language.english': '英语：无障碍工作沟通',
    'skills.language.mandarin': '普通话：母语',
    'skills.language.japanese': '日语：无障碍工作沟通',
    'skills.programming.title': '编程技能',
    'skills.programming.item1': 'TypeScript / React / Next.js 前端',
    'skills.programming.item2': 'Three.js、WebGL 与着色器动画',
    'skills.programming.item3': 'Node.js 自动化与 AI 工具链',
    'skills.professional.title': '专业能力',
    'skills.professional.item1': '创意统筹与互动叙事',
    'skills.professional.item2': '活动效果衡量与内容运营',
    'skills.professional.item3': '客户工作坊引导',
    'split.offer.title': '这就是我',
    'split.offer.item1': '充满热情的合作对象',
    'split.offer.item2': '对世界保持好奇的朋友',
    'split.offer.item3': '具备全球视野的多语沟通者',
    'split.offer.item4': '终身学习的伙伴',
    'split.contact.title': '联系我',
    'split.contact.body': '欢迎随时与我联系——我很期待与你相遇交流。',
    'split.contact.mail': '邮箱',
    'footer.copy': '© 2025 Xinrou · My Page',
    'chatbot.title': '和我聊天',
    'chatbot.lead': '想了解我的工作、兴趣或想法？点击常用问题卡或直接提问。',
    'chatbot.input.placeholder': '请输入你的问题…',
    'chatbot.noKey': '直接开始聊天，无需任何设置。',
    'chatbot.send': '发送',
    'chatbot.quick.q1': '你将来的职业理想是什么？',
    'chatbot.quick.q2': '你做了哪些努力？',
    'chatbot.quick.q3': '来约一个 Coffee Chat 吧！',
    'chatbot.welcome': '很高兴与你聊天！我是Xinrou，你有什么想问我的吗？',
    'chatbot.noKey': '直接开始聊天，无需任何设置。',
    'chatbot.error': '抱歉，暂时无法连接模型，请稍后再试。',
    'chatbot.empty': '没有收到回复，可以再试一次吗？',
    'chatbot.systemPrompt': '你是 Xinrou 的友好助手，请简洁、温暖地回答，并邀请对方合作。',
    'chatbot.note': '这些回答由我的私人助手生成，帮你更快了解我。',
    'contact.table.title': '留下信息，我会尽快联系你',
    'contact.table.name': '姓名',
    'contact.table.firstName': '名',
    'contact.table.lastName': '姓（Last name）',
    'contact.table.org': '组织名称',
    'contact.table.email': '邮箱',
    'contact.table.message': '咨询内容',
    'contact.table.submit': '生成邮件',
    'contact.table.helper': '点击后会打开邮件草稿，你可以在发送前自由修改。',
  },
  ja: {
    'lang.option.en': '英語',
    'lang.option.ja': '日本語',
    'lang.option.zh': '中国語',
    'nav.projects': 'プロジェクト',
    'nav.journey': '経歴',
    'nav.contact': '連絡先',
    'hero.greeting': 'こんにちは、',
    'hero.name': 'Xinrouです',
    'hero.lead': '世界を胸に抱き、人生の無限の可能性を旅しつつ、皆んなに幸せを届けたい。',
    'hero.contact': 'お問い合わせ',
    'labs.title': 'プロジェクトハイライト',
    'labs.card1.tag': 'LIVE-AI',
    'labs.card1.title': 'ネオンパルススタジオ',
    'labs.card1.desc': 'GPTエージェントがリアルタイムでプロンプト・ビート・ライトをリミックスするインタラクティブ配信ルーム。',
    'labs.card1.meta': '2024 · ベータ',
    'labs.card2.tag': 'AR',
    'labs.card2.title': 'ホロループ',
    'labs.card2.desc': 'WebAR と Effect House で制作したウェアラブル粒子ループで、ビートごとに色が変化します。',
    'labs.card2.meta': '2023 · ローンチ',
    'labs.card3.tag': 'DATA',
    'labs.card3.title': 'クリエイターレーダー',
    'labs.card3.desc': 'TikTok API 統計、コマース転換、コンテンツ洞察を統合したブランド向けのシグナルボード。',
    'labs.card3.meta': '2022 · SaaS',
    'timeline.title': '人生はひとつの冒険、これは私が紡ぐ旅路',
    'timeline.item1.title': '2023 - 現在 · クリエイティブテックリード',
    'timeline.item1.desc': 'AI シーン演出と自動オーバーレイを備えた商用ライブ配信システムを設計。',
    'timeline.item2.title': '2021 - 2023 · プロダクトストーリーテラー',
    'timeline.item2.desc': 'ライフスタイルブランドの TikTok 初展開向けキャンペーンストーリーを制作。',
    'timeline.item3.title': '2019 - 2021 · イマーシブデベロッパー',
    'timeline.item3.desc': 'AR フィルター、モーションキャプチャパペット、マルチデバイス連動のインタラクティブサイトを構築。',
    'timeline.item4.title': '2017 - 2019 · ビジュアルデザイナー',
    'timeline.item4.desc': 'エンタメ & テックパートナー向けにキネティックタイポグラフィとフェスビジュアルを制作。',
    'skills.title': '言語とスキル',
    'skills.language.title': '言語スキル',
    'skills.language.english': '英語：ビジネス上級',
    'skills.language.mandarin': '中国語：母国語',
    'skills.language.japanese': '日本語：ビジネス上級',
    'skills.programming.title': 'プログラミングスキル',
    'skills.programming.item1': 'TypeScript / React / Next.js フロントエンド',
    'skills.programming.item2': 'Three.js・WebGL・シェーダーアニメーション',
    'skills.programming.item3': 'Node.js 自動化と AI ツールチェーン',
    'skills.professional.title': 'プロフェッショナルスキル',
    'skills.professional.item1': 'クリエイティブディレクションとインタラクティブストーリーテリング',
    'skills.professional.item2': 'キャンペーン計測とコンテンツ運用',
    'skills.professional.item3': 'クライアントワークショップのファシリテーション',
    'split.offer.title': 'これが私',
    'split.offer.item1': '情熱的なパートナー',
    'split.offer.item2': '世界への好奇心が尽きない友人',
    'split.offer.item3': 'グローバル志向のマルチリンガルコミュニケーター',
    'split.offer.item4': '生涯学習に寄り添う仲間',
    'split.contact.title': 'お問い合わせ',
    'split.contact.body': 'いつでもお気軽にご連絡ください。お話しできるのを楽しみにしています。',
    'split.contact.mail': 'メールアドレス',
    'footer.copy': '©2025 Xinrou · My Page',
    'chatbot.title': '私と話そう',
    'chatbot.lead': '私の仕事や興味、アイデアについて気軽に質問してください。カードからも始められます。',
    'chatbot.input.placeholder': '質問を書いてください…',
    'chatbot.noKey': 'セットアップ不要です。すぐにメッセージを送ってください。',
    'chatbot.send': '送信',
    'chatbot.quick.q1': '将来のキャリアの理想は何ですか？',
    'chatbot.quick.q2': 'そのためにどんな努力をしましたか？',
    'chatbot.quick.q3': 'コーヒーチャットをしませんか？',
    'chatbot.welcome': 'お話しできて嬉しいです！Xinrouです。何を聞いてみたいですか？',
    'chatbot.noKey': 'セットアップ不要です。すぐにメッセージを送ってください。',
    'chatbot.error': '接続に失敗しました。時間をおいて再試行してください。',
    'chatbot.empty': '返信が得られませんでした。もう一度試せますか？',
    'chatbot.systemPrompt': 'あなたは Xinrou のフレンドリーなアシスタントです。簡潔かつ温かく、コラボに誘う形で答えてください。',
    'chatbot.note': '私についての質問に答えるパーソナルアシスタントが対応します。',
    'contact.table.title': '連絡先を残してください、すぐお返事します',
    'contact.table.name': 'お名前',
    'contact.table.firstName': '名',
    'contact.table.lastName': '姓 (ラストネーム)',
    'contact.table.org': '所属・組織名',
    'contact.table.email': 'メールアドレス',
    'contact.table.message': 'お問い合わせ内容',
    'contact.table.submit': 'メール下書きを作成',
    'contact.table.helper': 'クリックするとメール下書きが開きます。送信前に自由に編集してください。',
  },
};

const DEFAULT_LANGUAGE = 'en';

const translateWithLang = (key, language) => {
  const fallback = translations[DEFAULT_LANGUAGE] || {};
  return translations[language]?.[key] ?? fallback[key] ?? key;
};

const navLinks = [
  { href: '#labs', key: 'nav.projects' },
  { href: '#timeline', key: 'nav.journey' },
  { href: '#contact', key: 'nav.contact' },
];

const heroLineKeysByLanguage = {
  default: ['hero.greeting', 'hero.name'],
};

const getHeroLineKeys = (language) => heroLineKeysByLanguage[language] || heroLineKeysByLanguage.default;

const createHeroLineState = (language) =>
  getHeroLineKeys(language).map((key) => ({ key, typed: '', complete: false }));

const quickQuestionKeys = ['chatbot.quick.q1', 'chatbot.quick.q2', 'chatbot.quick.q3'];

const labsCards = [
  {
    key: 'card1',
    tagKey: 'labs.card1.tag',
    titleKey: 'labs.card1.title',
    descKey: 'labs.card1.desc',
    metaKey: 'labs.card1.meta',
  },
  {
    key: 'card2',
    tagKey: 'labs.card2.tag',
    titleKey: 'labs.card2.title',
    descKey: 'labs.card2.desc',
    metaKey: 'labs.card2.meta',
  },
  {
    key: 'card3',
    tagKey: 'labs.card3.tag',
    titleKey: 'labs.card3.title',
    descKey: 'labs.card3.desc',
    metaKey: 'labs.card3.meta',
  },
];

const timelineEntries = [
  { titleKey: 'timeline.item1.title', descKey: 'timeline.item1.desc' },
  { titleKey: 'timeline.item2.title', descKey: 'timeline.item2.desc' },
  { titleKey: 'timeline.item3.title', descKey: 'timeline.item3.desc' },
  { titleKey: 'timeline.item4.title', descKey: 'timeline.item4.desc' },
];

const skills = [
  {
    titleKey: 'skills.language.title',
    items: ['skills.language.english', 'skills.language.mandarin', 'skills.language.japanese'],
  },
  {
    titleKey: 'skills.programming.title',
    items: ['skills.programming.item1', 'skills.programming.item2', 'skills.programming.item3'],
  },
  {
    titleKey: 'skills.professional.title',
    items: ['skills.professional.item1', 'skills.professional.item2', 'skills.professional.item3'],
  },
];

const offerings = [
  'split.offer.item1',
  'split.offer.item2',
  'split.offer.item3',
  'split.offer.item4',
];

const { createApp } = Vue;

const app = createApp({
  data() {
    const initialLanguage = document.documentElement.lang || DEFAULT_LANGUAGE;
    return {
      navLinks,
      labsCards,
      timelineEntries,
      skills,
      offerings,
      languages: ['en', 'ja', 'zh'],
      currentLanguage: initialLanguage,
      languageMenuOpen: false,
      heroLines: createHeroLineState(initialLanguage),
      pulseFrame: null,
      typingRunId: 0,
      chatMessages: [],
      chatInput: '',
      isChatLoading: false,
      quickQuestionKeys,
      contactForm: {
        firstName: '',
        lastName: '',
        email: '',
        org: '',
        message: '',
      },
    };
  },
  computed: {
    languageLabel() {
      return this.t('lang.option.' + this.currentLanguage);
    },
  },
  methods: {
    t(key) {
      const fallback = translations[DEFAULT_LANGUAGE] || {};
      return translations[this.currentLanguage]?.[key] ?? fallback[key] ?? key;
    },
    toggleLanguageMenu() {
      this.languageMenuOpen = !this.languageMenuOpen;
    },
    setLanguage(language) {
      const normalized = translations[language] ? language : DEFAULT_LANGUAGE;
      if (normalized !== this.currentLanguage) {
        this.currentLanguage = normalized;
      }
      this.languageMenuOpen = false;
    },
    onDocumentClick(event) {
      const switcher = this.$refs.languageSwitcher;
      if (switcher && !switcher.contains(event.target)) {
        this.languageMenuOpen = false;
      }
    },
    handlePointer(event) {
      const target = event.currentTarget;
      if (!(target instanceof HTMLElement)) return;
      const rect = target.getBoundingClientRect();
      const x = ((event.clientX - rect.left) / rect.width) * 100;
      const y = ((event.clientY - rect.top) / rect.height) * 100;
      target.style.setProperty('--mouse-x', `${x}%`);
      target.style.setProperty('--mouse-y', `${y}%`);
    },
    sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    },
    async runTypingSequence() {
      const runId = ++this.typingRunId;
      const keys = getHeroLineKeys(this.currentLanguage);
      if (keys.length !== this.heroLines.length || keys.some((key, index) => this.heroLines[index]?.key !== key)) {
        this.heroLines = createHeroLineState(this.currentLanguage);
      }
      this.heroLines.forEach((line) => {
        line.typed = '';
        line.complete = false;
      });
      await this.sleep(400);
      for (const line of this.heroLines) {
        const text = this.t(line.key);
        await this.typeText(line, text, runId);
        if (runId !== this.typingRunId) {
          return;
        }
      }
    },
    typeText(line, text, runId) {
      return new Promise((resolve) => {
        const safeText = text ?? '';
        let index = 0;
        const typeNext = () => {
          if (runId !== this.typingRunId) {
            resolve();
            return;
          }
          if (index <= safeText.length) {
            line.typed = safeText.slice(0, index);
            index += 1;
            if (index <= safeText.length) {
              setTimeout(typeNext, 120);
            } else {
              line.complete = true;
              resolve();
            }
          } else {
            resolve();
          }
        };
        typeNext();
      });
    },
    startPulseAnimation() {
      const animatePulse = (timestamp) => {
        const intensity = Math.sin(timestamp / 250) * 0.08 + 0.18;
        document.documentElement.style.setProperty('--border', `rgba(12, 16, 35, ${0.08 + intensity})`);
        this.pulseFrame = requestAnimationFrame(animatePulse);
      };
      this.pulseFrame = requestAnimationFrame(animatePulse);
    },
    stopPulseAnimation() {
      if (this.pulseFrame) {
        cancelAnimationFrame(this.pulseFrame);
        this.pulseFrame = null;
      }
    },
    async sendMessage() {
      const content = this.chatInput.trim();
      if (!content || this.isChatLoading) return;
      this.chatMessages.push({ role: 'user', content });
      this.chatInput = '';

      this.isChatLoading = true;

      try {
        let reply = '';

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: content,
          }),
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        reply = data?.reply?.trim();

        this.chatMessages.push({ role: 'assistant', content: reply || this.t('chatbot.empty') });
      } catch (error) {
        this.chatMessages.push({ role: 'assistant', content: `${this.t('chatbot.error')} ${error?.message ?? ''}`.trim() });
      } finally {
        this.isChatLoading = false;
      }
    },
    askQuickQuestion(questionKey) {
      const text = this.t(questionKey);
      this.chatInput = text;
      this.sendMessage();
    },
    submitContactForm() {
      const { firstName, lastName, email, org, message } = this.contactForm;
      const displayName = [firstName, lastName].filter(Boolean).join(' ').trim();
      const subject = encodeURIComponent(`${displayName || 'New friend'} · Inquiry`);
      const body = encodeURIComponent(
        `First name: ${firstName || '-'}\nLast name: ${lastName || '-'}\nEmail: ${email || '-'}\nOrganization: ${org || '-'}\nInquiry: ${message || '-'}`,
      );
      window.location.href = `mailto:xinrou.dong@outlook.com?subject=${subject}&body=${body}`;
    },
  },
  watch: {
    currentLanguage() {
      document.documentElement.setAttribute('lang', this.currentLanguage);
      this.languageMenuOpen = false;
      this.runTypingSequence();
    },
  },
  mounted() {
    document.addEventListener('click', this.onDocumentClick);
    document.documentElement.setAttribute('lang', this.currentLanguage);
    this.startPulseAnimation();
    this.runTypingSequence();
  },
  beforeUnmount() {
    document.removeEventListener('click', this.onDocumentClick);
    this.stopPulseAnimation();
  },
});

const appInstance = app.mount('#app');
window.__app = appInstance;
